{% extends 'main/base.html' %}
{% load static %}
{% block flash_messages %}

    {% endblock %}
{% block content %}
<style>

    .image-preview {
    display: inline-block;
    margin: 10px 0;
}

.image-preview img.chat-img-preview {
    width: 100px;      /* Fixed width */
    height: 100px;     /* Fixed height */
    object-fit: cover; /* Crop to fit */
    border-radius: 10px;
    border: 1px solid #ccc;
}




.chat-container {
  width: 100%;
  max-width: 500px;
  height: 600px;
  background-color: #2c003e;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.chat-nav {
  height: 50px;
  background: linear-gradient(43deg, #6a0dad, #c850c0, #ffcc70);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 15px;
  color: white;
  font-weight: bold;
}

.chat-close {
  width: 40px;
  height: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  cursor: pointer;
}

.chat-line {
  position: absolute;
  width: 20px;
  height: 3px;
  background-color: white;
  border-radius: 30px;
}
.chat-line.one { transform: rotate(45deg); }
.chat-line.two { transform: rotate(135deg); }

.chat-messages {
  flex: 1;
  padding: 15px;
  background-color: #3b0066;
  overflow-y: auto;
}

.chat-message {
  display: flex;
  align-items: flex-end;
  margin-bottom: 15px;
}

.chat-message.me { flex-direction: row-reverse; }

.chat-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid white;
  margin: 0 8px;
}

.chat-bubble {
  background-color: #fff;
  color: #333;
  padding: 10px 15px;
  border-radius: 12px;
  max-width: 70%;
  position: relative;
}
.chat-message.me .chat-bubble {
  background-color: #9b4de4;
  color: white;
}
.chat-bubble small {
  display: block;
  text-align: right;
  color: rgba(255,255,255,0.8);
  font-size: 0.75rem;
}

.chat-img {
  max-width: 180px;
  border-radius: 8px;
  margin-top: 5px;
}

.chat-sender {
  background-color: #2c003e;
  padding: 10px;
}

.chat-input-box {
  display: flex;
  align-items: center;
  background-color: #4e0077;
  border-radius: 8px;
  padding: 5px 10px;
  gap: 5px;
}

.chat-input {
  flex: 1;
  border: none;
  background: transparent;
  color: white;
  outline: none;
  padding: 5px;
}
.chat-input::placeholder {
  color: #ddd;
}

.chat-file {
  max-width: 140px;
  color: white;
}

.chat-send {
  background-color: #9b4de4;
  border: none;
  width: 35px;
  height: 35px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.chat-send-icon {
  width: 18px;
  height: 18px;
  fill: white;
}

</style>
<div class="chat-container mx-auto mt-4">
    <div class="chat-nav">
        <a>محادثة مع {{ other_participant.username }}</a>
        <a href="{% url 'discussion_list' %}" class="chat-close-btn">

        <div class="chat-close">
            <div class="chat-line one"></div>
            <div class="chat-line two"></div>
        </div>
    </div>

    <!-- Messages -->
    <div class="chat-messages" id="chatMessages">
        {% for msg in messages %}
        <div class="chat-message {% if msg.sender == request.user %}me{% else %}other{% endif %}" data-message-id="{{ msg.id }}">
            <a href="{% url 'view_profile' msg.sender.id %}">
                <img src="{{ msg.sender.profile.image.url|default:'/media/profile_images/default.png' }}" class="chat-avatar">
            </a>
            <div class="chat-bubble">
                {% if msg.content %}<p>{{ msg.content }}</p>{% endif %}
                {% if msg.image %}<img src="{{ msg.image.url }}" class="chat-img">{% endif %}
                <small style="color: black;">{{ msg.timestamp|date:"H:i" }}</small>
            </div>
        </div>
        {% empty %}
        <p class="text-center text-light mt-3" id="noMessages">ابدأ المحادثة الآن</p>
        {% endfor %}
    </div>

    <!-- Sender -->
    <div class="chat-sender">
        <form id="messageForm" method="POST" enctype="multipart/form-data" class="chat-input-box">
            {% csrf_token %}
            <input type="text" name="content" id="messageInput" placeholder="اكتب رسالتك..." class="chat-input">
            <input type="file" name="image" id="image-upload" class="chat-file d-none">
            <label for="image-upload" class="chat-send attach"><i class="fas fa-image"></i></label>
            <button type="submit" class="chat-send">
                <svg class="chat-send-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                    <path fill="#fff" d="M481.5 210.3 68.4 38.9c-17.4-7.2-37.1-4-51.3 8.3C2.9 59.5-3.1 78.6 1.6 96.8L38.3 241h180c8.3 0 15 6.7 15 15s-6.7 15-15 15H38.3L1.6 415.2c-4.7 18.3 1.3 37.3 15.5 49.6 14.3 12.4 33.9 15.5 51.3 8.3l413.1-171.4c18.8-7.6 30.5-25.1 30.5-45.4 0-20.4-11.7-37.9-30.5-45.4z"/>
                </svg>
            </button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chatMessages');
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const imageUpload = document.getElementById('image-upload');
    const noMessages = document.getElementById('noMessages');
    let lastMessageId = {{ messages.last.id|default:0 }};

    chatMessages.scrollTop = chatMessages.scrollHeight;

    // Poll messages
    function pollMessages() {
        fetch(`/discussion/{{ discussion.id }}/messages/?last_id=${lastMessageId}`, {
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(res => res.json())
        .then(data => {
            if (data.messages.length > 0) {
                if (noMessages) noMessages.remove();
                data.messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = `chat-message ${msg.sender_id === {{ request.user.id }} ? 'me' : 'other'}`;
                    div.setAttribute('data-message-id', msg.id);
                    div.innerHTML = `
                        <a href="/profile/${msg.sender_id}/">
                            <img src="${msg.sender_profile_image}" class="chat-avatar">
                        </a>
                        <div class="chat-bubble">
                            ${msg.content ? `<p>${msg.content}</p>` : ''}
                            ${msg.image ? `<img src="${msg.image}" class="chat-img">` : ''}
                            <small>${msg.timestamp}</small>
                        </div>
                    `;
                    chatMessages.appendChild(div);
                    lastMessageId = Math.max(lastMessageId, msg.id);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        })
        .catch(err => console.error(err));
    }
    setInterval(pollMessages, 3000);

    // Send message
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(messageForm);

        fetch(`/discussion/{{ discussion.id }}/`, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                // ✅ Clear inputs
                messageInput.value = '';
                imageUpload.value = '';
                const preview = document.querySelector('.image-preview');
                if (preview) preview.remove();
                pollMessages();
            }
        })
        .catch(err => console.error('Send error:', err));
    });

    // Image preview
    imageUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(ev) {
                const preview = document.createElement('div');
                preview.className = 'image-preview';
                preview.innerHTML = `<img src="${ev.target.result}" class="chat-img-preview">`;
                messageForm.before(preview);
            };
            reader.readAsDataURL(file);
        }
    });
});
</script>

{% endblock %}








import os
from pathlib import Path

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-wny3zd)pj0*vg+!x+o#%=9byx==yz6bf=+4d!(cr_sr)&m@l86'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = ['androbiert.pythonanywhere.com']


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'main',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'love_project.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'love_project.wsgi.application'


# Database
# https://docs.djangoproject.com/en/5.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'androbiert$default',
        'USER': 'androbiert',
        'PASSWORD': 'matH@02@',
        'HOST': 'androbiert.mysql.pythonanywhere-services.com',
        'OPTIONS': {
            'charset': 'utf8mb4',
        },
    }
}


# Password validation
# https://docs.djangoproject.com/en/5.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    # {
    #     'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    # },
    # {
    #     'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    # },
    # {
    #     'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    # },
]





# Internationalization
# https://docs.djangoproject.com/en/5.2/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.2/howto/static-files/

STATIC_URL = '/static/'  # ✅ URL, not full path
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')  # ✅ where collectstatic copies files
STATICFILES_DIRS = [os.path.join(BASE_DIR, 'static')]  # ✅ where you keep your CSS/JS



# Default primary key field type
# https://docs.djangoproject.com/en/5.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media'

