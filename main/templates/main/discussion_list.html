{% extends 'main/base.html' %}
{% block content %}

<div class="container mt-4">
    <h1 class="text-center mb-4">💌 محادثاتي</h1>

    <!-- Search Form -->
    <form method="GET" action="{% url 'search_users' %}" class="mb-4">
        <div class="input-group shadow-sm">
            <input type="text" name="q" class="form-control" 
                   placeholder="🔎 ابحث عن مستخدم..." value="{{ query|default:'' }}">
            <button type="submit" class="btn btn-love px-4">بحث</button>
        </div>
    </form>

    <!-- Search Results -->
    {% if users %}
        <h3 class="mb-3">📜 نتائج البحث</h3>
        <div class="row">
            {% for user in users %}
                {% if user.id %}
                    <div class="col-md-4 mb-3">
                        <div class="card shadow border-0 rounded-4">
                            <div class="card-body text-center">
                                <a href="{% url 'view_profile' user_id=user.id %}">
                                    <img src="{{ user.profile.image.url|default:'/media/profile_images/default.png' }}" 
                                         alt="{{ user.username }}" 
                                         class="rounded-circle shadow mb-2" 
                                         width="80" height="80">
                                </a>
                                <h5 class="card-title fw-bold">{{ user.username }}</h5>
                                <a href="{% url 'start_discussion' user_id=user.id %}" 
                                   class="btn btn-love mt-2">بدء مناقشة</a>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <p class="text-muted">مستخدم غير صالح</p>
                {% endif %}
            {% endfor %}
            {% if not users %}
                <p>❌ لا توجد نتائج للبحث.</p>
            {% endif %}
        </div>
    {% endif %}

    <!-- Discussion List -->
    <h3 class="mt-5 mb-3">💬 قائمة المناقشات</h3>
    <div class="row">
        {% for data in discussion_data %}
            {% if data.other_participant and data.other_participant.id %}
                <div class="col-md-4 mb-3">
                    <div class="card shadow border-0 rounded-4">
                        <div class="card-body d-flex align-items-center">
                            <!-- Profile Image -->
                            <a href="{% url 'view_profile' user_id=data.other_participant.id %}">
                                <img src="{{ data.other_participant.profile.image.url|default:'/media/profile_images/default.png' }}" 
                                     alt="{{ data.other_participant.username }}" 
                                     class="rounded-circle me-3 shadow-sm border border-2" 
                                     width="60" height="60">
                            </a>
                            
                            <div>
                                <!-- Username -->
                                <h5 class="mb-1">
                                    <a href="{% url 'discussion_detail' data.discussion.id %}" 
                                       class="text-decoration-none text-dark fw-bold">
                                       {{ data.other_participant.username }}
                                    </a>
                                </h5>
                                <!-- Last message -->
                                <p class="text-muted mb-0 small">
                                    {% if data.discussion.messages.last %}
                                        {{ data.discussion.messages.last.content|truncatewords:6 }}
                                    {% else %}
                                        لا توجد رسائل بعد
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <p class="text-muted">مناقشة غير صالحة</p>
            {% endif %}
        {% endfor %}
        {% if not discussion_data %}
            <p class="text-center mt-3" style="color: #fff; font-weight: bold;">🚫 لا توجد مناقشات بعد.</p>
        {% endif %}
    </div>
</div>

{% endblock %}