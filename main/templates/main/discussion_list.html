{% extends 'main/base.html' %}
{% block content %}

<style>

.chat-card {
    background: #9b4de4;
    transition: background 0.3s;
}
.chat-card:hover {
    background: rgba(255, 255, 255, 0.15);
}
.profile-hover {
    transition: box-shadow 0.3s;
}
.profile-hover:hover {
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
}
.custom-dropdown .btn {
    font-size: 1.2rem;
    padding: 0.25rem 0.5rem;
    background: rgba(255,255,255,0.1);
    border: none;
    transition: background 0.3s, transform 0.2s;
}
.custom-dropdown .btn:hover {
    background: rgba(255,255,255,0.25);
    transform: scale(1.1);
}
.custom-dropdown .dropdown-menu {
    background: rgba(20, 20, 20, 0.95);
    border: none;
    z-index: 9999;
    position: absolute;
}
.custom-dropdown .dropdown-item:hover {
    background: rgba(255, 255, 255, 0.1);
}
.alert-error {
    background-color: #ce150f;
    color: #f5f5f5;
    border: none;
}
.card {
    overflow: visible !important;
}
</style>
<div class="container mt-4">
    <h1 class="text-center mb-4">💌 محادثاتي</h1>

    <!-- Search Form -->
    <form method="GET" action="{% url 'search_users' %}" class="mb-4">
        <div class="input-group shadow-sm">
            <input type="text" name="q" class="form-control" 
                   placeholder="🔎 ابحث عن مستخدم..." value="{{ query|default:'' }}">
            <button type="submit" class="btn btn-love px-4">بحث</button>
        </div>
    </form>

    <!-- Search Results -->
    {% if users %}
        <h3 class="mb-3 text-light">📜 نتائج البحث</h3>
        <div class="row">
            {% for user in users %}
                {% if user.id %}
                    <div class="col-md-4 mb-3">
                        <div class="card shadow border-0 rounded-4 chat-card">
                            <div class="card-body text-center">
                                <a href="{% url 'view_profile' user_id=user.id %}">
                                    <img src="{{ user.profile.image.url|default:'/media/profile_images/default.png' }}" 
                                         alt="{{ user.username }}" 
                                         class="rounded-circle shadow mb-2 profile-hover" 
                                         width="80" height="80">
                                </a>
                                <h5 class="card-title fw-bold text-light">{{ user.username }}</h5>
                                <a href="{% url 'start_discussion' user_id=user.id %}" 
                                   class="btn btn-love mt-2">بدء مناقشة</a>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <p class="text-muted">مستخدم غير صالح</p>
                {% endif %}
            {% endfor %}
            {% if not users %}
                <p class="text-light">❌ لا توجد نتائج للبحث.</p>
            {% endif %}
        </div>
    {% endif %}

    <!-- Discussion List -->
    <h3 class="mt-5 mb-3 text-light">💬 قائمة المناقشات</h3>
    <div class="row">
        {% for data in discussion_data %}
            {% if data.other_participant and data.other_participant.id %}
                <div class="col-md-4 mb-3">
                    <div class="card shadow border-0 rounded-4 chat-card position-relative">

                        <!-- Options Dropdown -->
                        <div class="dropdown position-absolute top-0 start-0 m-2 custom-dropdown">
    <button class="btn btn-sm btn-outline-light rounded-circle shadow-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false">
        ⋮
    </button>
    <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-start shadow-lg rounded-3" >
        <li class="dropdown-item  small ">
            📅 أنشئت: {{ data.discussion.created_at|date:"Y-m-d H:i" }}
        </li>
        <li class="dropdown-item small">
            👥 المشاركون: <br>
            {{ data.other_participant.username }} و {{ request.user.username }}
        </li>
        <li>
            <form method="POST" action="{% url 'delete_discussion' data.discussion.id %}" 
                  onsubmit="return confirm('هل أنت متأكد أنك تريد حذف هذه المناقشة؟');">
                {% csrf_token %}
                <button type="submit" class="dropdown-item text-danger small">
                    🗑 حذف
                </button>
            </form>
        </li>
    </ul>
</div>


                        <a href="{% url 'discussion_detail' data.discussion.id %}" class="text-decoration-none" style="color: inherit;">
                            <div class="card-body d-flex align-items-center">
                                <!-- Profile Image -->
                                <img src="{{ data.other_participant.profile.image.url|default:'/media/profile_images/default.png' }}" 
                                     alt="{{ data.other_participant.username }}" 
                                     class="rounded-circle me-3 shadow-sm border border-2 profile-hover" 
                                     width="60" height="60">
                                
                                <div>
                                    <!-- Username -->
                                    <h5 class="mb-1 fw-bold" style="color: #ffffff;">
                                        {{ data.other_participant.username }}
                                    </h5>
                                    <!-- Last message -->
                                    <p class="mb-0 small" style="color: rgba(255, 255, 255, 0.8);">
                                        {% if data.discussion.messages.last %}
                                            {{ data.discussion.messages.last.content|truncatewords:6 }}
                                        {% else %}
                                            لا توجد رسائل بعد
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            {% else %}
                <p class="text-light">مناقشة غير صالحة</p>
            {% endif %}
        {% endfor %}
        {% if not discussion_data %}
            <p class="text-center mt-3" style="color: #fff; font-weight: bold;">🚫 لا توجد مناقشات بعد.</p>
        {% endif %}
    </div>
</div>



{% endblock %}
